<html>
    <head>
        <title>Home Page</title>
        <link rel = "stylesheet" href="style.css">
    </head>

    <body>
        <!--header -->
        <header id="header-footerbar">
            <h1> Makeup Manager</h1>
        </header>
    
        <!-- navigation Bar -->
        <nav id="main-nav">
            <ul>
                <li><a href="projectmainpage.html">Home</a></li>
                <li><a href="About Page.html">About</a></li>
                <li><a href="Contact Us Page.html">Contact</a></li>
                <li><a href="settingPage.html">Settings</a></li>
                <li><a href="userAccount.html">Account</a></li>
            </ul>
        </nav>   
        
        <!-- loading popup -->
        <div id="loading-popup">Loading recommendations, please wait 12 seconds...</div>

        <!-- search bar -->
        <div id="search-container">
            <input type="text" id="search-bar" placeholder="Search for any products..." />
        </div>

        <main>
            <!-- filter section -->
            <aside id="filter-container">
                <h3>Product Filters:</h3>
                <ul>
                    <li><input type="checkbox" id="foundation" name="foundation"> Foundation</li>
                    <li><input type="checkbox" id="concealer" name="concealer"> Concealer</li>
                    <li><input type="checkbox" id="bronzer" name="bronzer"> Bronzer</li>
                    <li><input type="checkbox" id="lipstick" name="lipstick"> Lipstick</li>
                    <li><input type="checkbox" id="nail-polish" name="nail_polish"> Nail Polish</li>
                    <li><input type="checkbox" id="blush" name="blush"> Blush</li>
                    <li><input type="checkbox" id="powder" name="powder"> Powder</li>
                </ul>
                <br>
                <h3>Price Filters:</h3>
                <ul>
                    <li><input type="checkbox" id="under-10" name="under-10"> Under $10</li>
                    <li><input type="checkbox" id="10-20" name="10-20"> $10 - $20</li>
                    <li><input type="checkbox" id="20-50" name="20-50"> $20 - $50</li>
                    <li><input type="checkbox" id="50-plus" name="50-plus"> $50 and above</li>
                </ul>
            </aside>

            <!-- recommendations section with headers-->
            <section id="home-recommendations">
                <h2>Welcome to Makeup Manager!</h2>
                <br>
                <br>
                <h2>Makeup reccomendations for you: </h2>
                <br>
                <br>
                <div id="recommendation-grid"></div>
            </section>
        </main>

        <script>
            const loadingPopup = document.getElementById('loading-popup');
            const recommendationsGrid = document.getElementById('recommendation-grid');
            const filterContainer = document.getElementById('filter-container');
            const searchBar = document.getElementById('search-bar');

            let allProducts = [];
            let filteredProducts = [];
            let savedProducts = [];

            loadingPopup.style.display = 'flex'; 
            setTimeout(() => {
                loadingPopup.innerText = 'Still loading, please wait...'; 
            }, 5000); // Update the message after 5 seconds of waiting

            fetch('http://makeup-api.herokuapp.com/api/v1/products.json')
                .then(response => response.json())
                .then(data => {
                    allProducts = data.map(product => {
                        if (product.product_type === "foundation") {
                            if (product.name.toLowerCase().includes("concealer")) {
                                product.category = "concealer";
                            } else if (product.name.toLowerCase().includes("bronzer")) {
                                product.category = "bronzer";
                            } else {
                                product.category = "foundation"; 
                            }
                        }
                        return product;
                    });

                    filteredProducts = getRandomProducts(allProducts, 24);
                                
                    setTimeout(() => {
                        displayProducts(filteredProducts);
                        loadingPopup.style.display = 'none'; 
                    }, 1000); // 1-second delay
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    loadingPopup.innerText = 'Failed to load recommendations. Please try again later.';
                });

                searchBar.addEventListener('input', () => {
                    const searchQuery = searchBar.value.toLowerCase();

                    const searchedProducts = filteredProducts.filter(product =>
                        product.name.toLowerCase().includes(searchQuery) || 
                        (product.brand && product.brand.toLowerCase().includes(searchQuery))
                    );

                    if (searchedProducts.length > 0) {
                        displayProducts(searchedProducts);
                    } else {
                        recommendationsGrid.innerHTML = '<p>No products match your search.</p>';
                    }
                });

            function displayProducts(products) {
                recommendationsGrid.innerHTML = '';
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('product-card');
                    productCard.innerHTML = `
                        <img src="${product.image_link || 'https://via.placeholder.com/200'}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200';">
                        <h2>${product.name}</h2>
                        <p>${product.brand}</p>
                        <p>$${product.price || 'N/A'}</p>
                        <button class="save-btn" data-id="${product.id}">Save</button>
                    `;
                    recommendationsGrid.appendChild(productCard);
                });

                document.querySelectorAll('.save-btn').forEach(button => {
                    button.addEventListener('click', () => saveProduct(button.getAttribute('data-id')));
                });
            }

            function getRandomProducts(array, n) {
                const randomIndices = new Set();
                while (randomIndices.size < n) {
                    const randomIndex = Math.floor(Math.random() * array.length);
                    randomIndices.add(randomIndex);
                }
                return Array.from(randomIndices).map(index => array[index]);
            }

            filterContainer.addEventListener('change', () => {
                const activeFilters = Array.from(filterContainer.querySelectorAll('input:checked')).map(filter => filter.name);

                const categoryFilters = activeFilters.filter(filter => !filter.includes('-'));
                const priceFilters = activeFilters.filter(filter => filter.includes('-') || filter === "50-plus");

                filteredProducts = allProducts.filter(product => {
                    let matchesCategory = false;
                    let matchesPrice = false;

                    if (categoryFilters.length === 0) {
                        matchesCategory = true; 
                    } else if (product.product_type === "foundation") {
                        if (categoryFilters.includes("foundation") && !["concealer", "bronzer"].includes(product.category)) {
                            matchesCategory = true;
                        }
                        if (categoryFilters.includes("concealer") && product.category === "concealer") {
                            matchesCategory = true;
                        }
                        if (categoryFilters.includes("bronzer") && product.category === "bronzer") {
                            matchesCategory = true;
                        }
                    } else {
                        matchesCategory = categoryFilters.includes(product.product_type);
                    }

                    const productPrice = parseFloat(product.price) || 0;
                    if (priceFilters.length === 0) {
                        matchesPrice = true; 
                    } else {
                        if (priceFilters.includes("under-10") && productPrice < 10) {
                            matchesPrice = true;
                        }
                        if (priceFilters.includes("10-20") && productPrice >= 10 && productPrice <= 20) {
                            matchesPrice = true;
                        }
                        if (priceFilters.includes("20-50") && productPrice > 20 && productPrice <= 50) {
                            matchesPrice = true;
                        }
                        if (priceFilters.includes("50-plus") && productPrice > 50) {
                            matchesPrice = true;
                        }
                    }

                    return matchesCategory && matchesPrice; 
                });

                if (filteredProducts.length === 0) {
                    recommendationsGrid.innerHTML = '<p>No products found for the selected filters.</p>';
                } else {
                    displayProducts(filteredProducts);
                }
            });


            function saveProduct(productId) {
                const product = allProducts.find(p => p.id == productId);
                if (product && !savedProducts.includes(product)) {
                    savedProducts.push(product);
                    alert(`${product.name} has been saved to your list!`);
                }
            }
        </script>
    </body>
</html>
